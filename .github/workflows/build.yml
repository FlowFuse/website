name: Build Site
on:
  workflow_dispatch:
  push:
    branches:
      - main
  schedule:
    - cron: "30 1 * * 5"
jobs:
  build_deploy:
    if: ${{ github.repository == 'FlowFuse/website' }}
    runs-on: ubuntu-latest
    steps:
      - name: Check out website repository
        uses: actions/checkout@v3
        with:
          path: 'website'
      - name: Check out FlowFuse/flowfuse repository (to access the docs)
        uses: actions/checkout@v3
        with:
          repository: 'FlowFuse/flowfuse'
          ref: maintenance
          path: 'flowfuse'
      - name: Check out FlowFuse/blueprint-library repository (to access the blueprints)
        uses: actions/checkout@v3
        with:
          repository: 'FlowFuse/blueprint-library'
          ref: main
          path: 'blueprints'
      - name: Install jq
        run: sudo apt-get -qy install jq
      - uses: actions/setup-node@v3
        with:
          cache: 'npm'
          cache-dependency-path: './website/package-lock.json'
      - run: npm run docs
        working-directory: 'website'
      - run: npm run blueprints
        working-directory: 'website'
      - name: Commit Latest Docs
        run: |
          cd ./website
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add src/docs/* -A -f
          git commit -a -m "Bot: update docs"
      - name: Commit Latest Blueprints
        run: |
          cd ./website
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add src/blueprints/* -A -f
          git commit -a -m "Bot: update blueprints"
      - name: Push to 'live' branch
        uses: ad-m/github-push-action@master
        with:
          directory: './website'
          branch: live
          force: true
